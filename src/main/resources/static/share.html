<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="pics/humbleicons--coffee.svg" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pandora Helper</title>
    <style>
        button {
            background-color: #43cea2;
            color: #fff;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9em;
            font-weight: 600;
        }

        button:hover {
            background-color: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        body, html {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: #f5f5f5;
        }

        .container {
            display: flex;
            height: 100%;
        }

        .sidebar {
            width: 220px;
            background-color: #ffffff;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            position: fixed; /* 固定导航栏 */
            height: 100%; /* 确保导航栏占满左侧高度 */
        }

        .sidebar h2 {
            color: #0e8f6f;
            margin-bottom: 20px;
            font-size: 22px;
        }

        .sidebar ul {
            list-style-type: none;
            padding: 0;
        }

        .sidebar li {
            margin-bottom: 15px;
        }

        .sidebar a {
            color: #333;
            text-decoration: none;
            font-size: 18px;
            display: block;
            padding: 10px 15px;
            border-radius: 4px;
            transition: background-color 0.3s, color 0.3s;
        }

        .sidebar a:hover, .sidebar a.active {
            background-color: #0e8f6f;
            color: #fff;
        }

        .main-content {
            margin-left: 240px; /* 确保内容部分从导航栏右侧开始 */
            padding: 20px;
            flex-grow: 1;
        }

        .panel {
            background-color: #ffffff;
            border-radius: 5px;
            padding: 15px;
            margin-left: 20px;
            height: 750px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .search-bar {
            display: flex;
            margin-bottom: 20px;
        }

        .search-bar input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px 0 0 4px;
        }

        .search-bar button {
            padding: 10px 20px;
            background-color: #0e8f6f;
            color: white;
            border: none;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f2f2f2;
        }

        .action-buttons button {
            margin-right: 5px;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .refresh-btn {
            background-color: #0e8f6f;
            color: white;
        }

        .open-share-btn {
            background-color: #0e8f6f;
            color: white;
        }

        .distribute-claude-btn {
            background-color: #6fafd2;
            color: white;
        }

        .distribute-gpt-btn {
            background-color: #43cea2;
            color: white;
        }

        .update-parent-btn {
            background-color: #f0ad99;
            color: white;
        }

        .edit-btn {
            background-color: #f0ad4e;
            color: white;
        }

        .delete-btn {
            background-color: #d9534f;
            color: white;
        }

        .create-new {
            float: right;
            padding: 10px 20px;
            background-color: #0e8f6f;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 20px;
        }

        /*.modal {*/
        /*    display: none;*/
        /*    position: fixed;*/
        /*    z-index: 1;*/
        /*    left: 0;*/
        /*    top: 0;*/
        /*    width: 100%;*/
        /*    height: 100%;*/
        /*    overflow: auto;*/
        /*    background-color: rgba(0, 0, 0, 0.4);*/
        /*}*/

        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border: 1px solid #888;
            width: auto; /* 适应内容宽度 */
            max-width: 500px; /* 最大宽度 */
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 600px) {
            .modal-content {
                max-width: 90%; /* 在小屏幕上占更大比例的宽度 */
            }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .ellipsis {
            max-width: 120px; /* 设置最大宽度，根据实际需求调整 */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: block; /* 确保应用block布局 */
        }

        .share-ellipsis {
            max-width: 150px; /* 设置最大宽度，根据实际需求调整 */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: block; /* 确保应用block布局 */
        }

        .modal {
            display: none;
            justify-content: center; /* 水平居中 */
            align-items: center; /* 垂直居中 */
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        form {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 300px;
        }

        label {
            display: block;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: #666;
        }

        input[type="username"],
        input[type="password"],
        input[type="text"] {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            margin-top: 1rem;
        }

        .checkbox-container label {
            margin-top: 0;
            margin-left: 0.5rem;
        }

        .tanchuang-button {
            display: block;
            width: 100%;
            padding: 0.75rem;
            background-color: #0e8f6f;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 1.5rem;
            font-size: 1rem;
        }

        /* 基本开关样式 */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        /* 隐藏默认的复选框 */
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        /* 滑块样式 */
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        /* 滑块::before 伪元素样式 */
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        /* 检查复选框是否被选中，更改滑块颜色 */
        input:checked + .slider {
            background-color: #2196F3;
        }

        /* 检查复选框是否被选中，移动滑块位置 */
        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* 可选：增加鼠标悬停效果 */
        .slider:hover {
            background-color: #7b7b7b;
        }

        #add-type {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        #configSelect {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .clickable {
            cursor: pointer;
        }

        tbody {
            font-size: 0.95em;
        }

        tbody tr {
            transition: all 0.2s ease-in-out;
            border-radius: 4px;
        }

        tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tbody tr:hover {
            background-color: #e9ecef;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        tbody td {
            padding: 12px 15px;
            vertical-align: middle;
            border-bottom: 1px solid #dee2e6;
            transition: all 0.2s ease-in-out;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        tbody td:first-child {
            font-weight: 500;
            color: #495057;
        }

        /*tbody td:not(:first-child) {*/
        /*    color: #6c757d;*/
        /*}*/

        tbody td:last-child {
            text-align: left;
        }

        /* 为长文本添加省略号 */
        tbody td.truncate {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 为状态类的列添加特殊样式 */
        tbody td.status {
            font-weight: 600;
        }

        tbody td.status-active {
            color: #28a745;
        }

        tbody td.status-inactive {
            color: #dc3545;
        }

        /* 为操作按钮添加样式 */
        tbody td .action-btn {
            padding: 6px 12px;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            font-size: 0.9em;
            transition: background-color 0.2s ease-in-out;
        }

        tbody td .action-btn:hover {
            background-color: #0056b3;
        }

        /* 表格整体样式 */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 1rem;
            font-size: 0.9em;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
        }

        /* 表头样式 */
        thead {
            background-color: #f5f5f5;
        }

        thead tr {
            background-color: #f5f5f5;
            color: #333;
            text-align: left;
            font-weight: bold;
        }

        thead th {
            padding: 12px 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        /* 表格行样式 */
        tr {
            border-bottom: 1px solid #e0e0e0;
        }

        tr:last-child {
            border-bottom: none;
        }

        tbody tr:nth-child(even) {
            background-color: #fafafa;
        }

        tbody tr:hover {
            background-color: #f0f0f0;
            transition: background-color 0.3s ease;
        }

        /* 表格单元格样式 */
        td, th {
            padding: 12px 15px;
            text-align: left;
        }

        /* 首列样式 */
        td:first-child, th:first-child {
            padding-left: 20px;
        }

        /* 末列样式 */
        td:last-child, th:last-child {
            padding-right: 20px;
        }

        /* 状态样式 */
        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
        }

        .status-active {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .status-inactive {
            background-color: #ffebee;
            color: #c62828;
        }

        /* 操作按钮样式 */
        .action-btn {
            padding: 6px 12px;
            border-radius: 4px;
            background-color: #2196f3;
            color: white;
            text-decoration: none;
            font-size: 0.9em;
            transition: background-color 0.2s ease-in-out;
        }

        .action-btn:hover {
            background-color: #1976d2;
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .pagination button {
            margin: 0 5px;
            padding: 5px 10px;
            cursor: pointer;
        }


        .user-menu {
            position: absolute;
            bottom: 0px;
            top: 773px;
            left: 10px;

        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #3498db;
            cursor: pointer;
            overflow: hidden;
        }
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .dropdown {
            display: none;
            position: absolute;
            top: 0;
            left: 50px;
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 4px;
            overflow: hidden;
            z-index: 1000;
        }

        .dropdown a {
            display: block;
            padding: 10px 20px;
            color: #333;
            text-decoration: none;
            white-space: nowrap;
        }
        .user-avatar:hover + .dropdown,
        .dropdown:hover {
            display: block;
        }

        .dropdown a:hover {
            background-color: #f4f4f4;
        }


        .user-menu {
            position: absolute;
            bottom: 0px;
            top: 773px;
            left: 10px;

        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #3498db;
            cursor: pointer;
            overflow: hidden;
        }
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .dropdown {
            display: none;
            position: absolute;
            top: 0;
            left: 50px;
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 4px;
            overflow: hidden;
            z-index: 1000;
        }

        .dropdown a {
            display: block;
            padding: 10px 20px;
            color: #333;
            text-decoration: none;
            white-space: nowrap;
        }
        .user-avatar:hover + .dropdown,
        .dropdown:hover {
            display: block;
        }

        .dropdown a:hover {
            background-color: #f4f4f4;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="sidebar">
        <h2>Pandora Helper</h2>
        <ul>
            <li><a href="#" id="accountNav">账号管理</a></li>
            <li><a href="#" id="shareNav" class="active">分享管理</a></li>
            <li><a href="#" id="carNav">停车场</a></li>
        </ul>
    </div>
    <div class="main-content">
        <div class="user-menu">
            <div class="user-avatar">
                <img id="avatar" src="/pics/linuxdo.webp" alt="User Avatar">
            </div>
            <div class="dropdown">
                <a href="#" onclick="logout()">退出登录</a>
            </div>
        </div>
        <div id="sharePanel" class="panel">
            <h2>分享管理</h2>
            <div class="search-bar">
                <input id="share-email-query" type="email-query" placeholder="输入邮箱或用户名">
                <button onclick="shareEmailQuery()">查询</button>
            </div>
            <table id="share_table">
                <thead>
                <tr>
                    <th>用户名</th>
                    <th>ChatGPT账号</th>
                    <th>Claude账号</th>
                    <th style="width: 100px">备注</th>
                    <th>过期时间</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody id="shareTableBody">

                </tbody>
            </table>
            <div class="pagination">
                <button id="sharePrevBtn">上一页</button>
                <span id="sharePageInfo"></span>
                <button id="shareNextBtn">下一页</button>
            </div>
        </div>
    </div>
</div>

<div id="configModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('configModal')">&times;</span>
        <h2>激活</h2>
        <form>
            <input type="hidden" id="distribute_share_id" name="distribute_share_id">
            <label for="configSelect">选择账号：</label>
            <select id="configSelect">
                <!--                <option value="option1">选项1</option>-->
                <!--                <option value="option2">选项2</option>-->
                <!-- 根据需要添加更多选项 -->
            </select>
            <button class="tanchuang-button" type="button" onclick="submitDistribute()">保存</button>
        </form>
    </div>
</div>

<div id="shareUpdateModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('shareUpdateModal')">&times;</span>
        <h2>修改共享</h2>
        <form>
            <input type="hidden" id="update-share-id" name="update-share-id">
            <input type="hidden" id="update-share-email" name="update-share-email">
            <label for="update-share-unique-name">用户名</label>
            <input type="text" id="update-share-unique-name" name="update-share-unique-name" readonly><br>
<!--            <label id='update-share-password-label' for="update-share-password">密码</label>-->
<!--            <input type="password" id="update-share-password" name="update-share-password" required><br>-->
            <label id='update-share-comment-label' for="update-share-comment">备注</label>
            <input type="text" id="update-share-comment" name="update-comment">
            <label id='update-share-expiration-label' for="update-share-expiration">过期时间</label>
            <input type="date" id="update-share-expiration" name="update-share-expiration"><br><br>
            <button class="tanchuang-button" type="button" onclick="updateShare()">保存</button>
        </form>
    </div>
</div>
</body>

<script type="text/javascript">

    function openShareUpdateModel(shareId, uniqueName, password, expiresAt, comment, email, curAdminId) {
        if (curAdminId !== 1 || shareId !== curAdminId) {
            document.getElementById('update-share-comment-label').style.display = 'none';
            document.getElementById('update-share-comment').style.display = 'none';
            document.getElementById('update-share-expiration').style.display = 'block';
            document.getElementById('update-share-expiration-label').style.display = 'block';
        }
        if (shareId ===curAdminId) {
            document.getElementById('update-share-expiration').style.display = 'none';
            document.getElementById('update-share-expiration-label').style.display = 'none';
            document.getElementById('update-share-comment-label').style.display = 'block';
            document.getElementById('update-share-comment').style.display = 'block';
        }

        openModal('shareUpdateModal')

        document.getElementById('update-share-id').value = shareId
        document.getElementById('update-share-unique-name').value = uniqueName
        document.getElementById('update-share-expiration').value = expiresAt
        document.getElementById('update-share-comment').value = comment
        document.getElementById('update-share-email').value = email
    }

    function updateParent(shareId) {
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "/share/updateParent?shareId=" + shareId, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.setRequestHeader('Authorization', "Bearer " + localStorage.getItem('token'));
        // 设置body
        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                let res = JSON.parse(xhr.responseText)
                if (res.status) {
                    alert("上山成功")
                } else {
                    alert(res.message);
                }
                fetchShares('','');
            }
        }
        xhr.send();
    }

    function deleteShare(id) {
        var xhr = new XMLHttpRequest();
        xhr.open("DELETE", "/share/delete?id=" + id, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.setRequestHeader('Authorization', "Bearer " + localStorage.getItem('token'));
        // 设置body
        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                // closeModal('shareModal')
                if (xhr.status === 200 && JSON.parse(xhr.responseText).status) {
                    alert("删除成功")
                    fetchShares('','')
                } else {
                    alert("删除失败");
                }
            }
        }
        xhr.send();
    }


    function updateShare() {
        var userId = document.getElementById('update-share-id').value;
        var expiration = document.getElementById('update-share-expiration').value;
        var email = document.getElementById('update-share-email').value;
        let comment = document.getElementById('update-share-comment').value;
        var xhr = new XMLHttpRequest();
        xhr.open("PATCH", "/share/update", true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.setRequestHeader('Authorization', "Bearer " + localStorage.getItem('token'));
        // 设置body
        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status === 200) {
                    closeModal('shareUpdateModal')
                    alert("更新成功")
                    fetchShares(email === 'undefined' ? '' : email,'')
                    document.getElementById('update-share-id').value = '';
                    document.getElementById('update-share-expiration').value = '';
                    document.getElementById('update-share-comment').value = '';
                } else {
                    alert("更新失败");
                }
            }
        }
        xhr.send(JSON.stringify({
            id: userId,
            expiresAt: expiration,
            comment: comment
        }));

    }


    function submitDistribute() {
        // 转换为数值类型configSelect
        var selectedConfig = parseInt(document.getElementById('configSelect').value);
        var shareId = parseInt(document.getElementById('distribute_share_id').value);
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/share/distribute", true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        // 设置token
        xhr.setRequestHeader('Authorization', "Bearer " + localStorage.getItem('token'));
        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                closeModal('configModal');
                var result = JSON.parse(xhr.responseText);
                if (result.status) {
                    alert("激活成功");
                } else {
                    alert("激活失败");
                }
                document.getElementById('distribute_share_id').value = ''
                fetchShares('','')
            }
        }
        xhr.send(JSON.stringify({id: shareId, accountId: selectedConfig}));

    }


    let curSharePage = 1;
    let total = 0;

    async function fetchShares(email, type) {
        const tableBody = document.getElementById('shareTableBody');

        const startIndex = (curSharePage - 1) * 8;
        const endIndex = startIndex + 8;

        document.getElementById('share-email-query').value = email;
        document.getElementById('sharePanel').style.display = 'block';
        document.getElementById('shareNav').classList.add('active');
        var xhr = new XMLHttpRequest();
        tableBody.innerHTML = ''; // 清空现有的表格内容
        xhr.open("GET", "/share/list?emailAddr=" + email+"&accountType="+type+"&start="+startIndex, true);
        xhr.setRequestHeader('Authorization', "Bearer " + localStorage.getItem('token'));
        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status === 200 && JSON.parse(xhr.responseText).status) {
                    const res = JSON.parse(xhr.responseText);
                    total = res.data.total
                    // const pageData = res.data.slice(startIndex, endIndex);

                    res.data.data.forEach(share => {
                        // const up = (share.id !== share.parentId)
                        //     ? `<button class="update-parent-btn" onclick="updateParent('${share.id}')">自立山头</button>`
                        //     : '';
                        const name = `<td>${share.uniqueName}</td>`
                        const gptEmail = (share.gptCarName === '-')
                            ? `<td style="width: 160px"><div class="share-ellipsis">${share.gptCarName}</div></td>`
                            : `<td style="width: 160px"><div class="share-ellipsis"><span class="clickable" onclick="getGptShare('${share.gptConfigId}')">${share.gptCarName}</span></div></td>`;
                        const claudeEmail = (share.claudeCarName === '-')
                            ? `<td style="width: 130px"><div class="share-ellipsis">${share.claudeCarName}</div></td>`
                            : `<td style="width: 130px"><div class="share-ellipsis"><span class="clickable" onclick="getClaudeShare('${share.claudeConfigId}')">${share.claudeCarName}</span></div></td>`;
                        const deleteEnable = share.curAdminId === 1 ?
                            `<button class="delete-btn" onclick="deleteShare(${share.id})">删除</button>` : ``
                        const row = `
                <tr>
                    ${name}
                    ${gptEmail}
                    ${claudeEmail}
                    <td style="width: 120px;">${share.comment}</td>
                    <td style="width: 120px;">${share.expiresAt}</td>
<!--                    <td>${share.gpt4Limit}</td>-->
                    <td>
                        <button class="distribute-gpt-btn" onclick="openEmailModal('${share.id}',1)">激活-ChatGPT</button>
                        <button class="distribute-claude-btn" onclick="openEmailModal('${share.id}',2)">激活-Claude</button>
                        <button class="edit-btn" onclick="openShareUpdateModel('${share.id}','${share.uniqueName}','${share.password}','${share.expiresAt}','${share.comment}','${share.email}', '${share.curAdminId}')">编辑</button>
                        ${deleteEnable}
                    </td>
                </tr>
            `;
                        tableBody.innerHTML += row;
                    });

                    updatePagination();
                }
            }
        }
        xhr.send()
    }

    function fetchConfigOptions(type) {
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "/account/options?type=" + type, true);
        xhr.setRequestHeader('Authorization', "Bearer " + localStorage.getItem('token'));
        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                var options = JSON.parse(xhr.responseText).data;
                var select = document.getElementById('configSelect');
                select.innerHTML = ''; // 清空现有选项

                let optEmpty = document.createElement('option');
                optEmpty.value = type === 1 ? "-1" : "-2"
                optEmpty.label = '-';
                optEmpty.innerHTML =
                select.appendChild(optEmpty);

                options.forEach(function (option) {
                    var opt = document.createElement('option');
                    opt.value = option.value;
                    opt.innerHTML = option.label;
                    select.appendChild(opt);
                });
            }
        };
        xhr.send();
    }


    function getGptShare(gptConfigId) {
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "/share/getGptShare?gptConfigId=" + gptConfigId, true);
        // xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.setRequestHeader('Authorization', "Bearer " + localStorage.getItem('token'));
        // 设置body
        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                let res = JSON.parse(xhr.responseText)
                if (res.status) {
                    window.open(res.data);
                } else {
                    alert(res.message);
                }
            }
        }
        xhr.send();
    }

    function getClaudeShare(gptConfigId) {
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "/share/getClaudeShare?claudeConfigId=" + gptConfigId, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.setRequestHeader('Authorization', "Bearer " + localStorage.getItem('token'));
        // 设置body
        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                let res = JSON.parse(xhr.responseText)
                if (res.status) {
                    window.open(res.data);
                } else {
                    alert(res.message);
                }
            }
        }
        xhr.send();
    }

    async function loadImg() {
        const imgSrc = localStorage.getItem('img');
        if (imgSrc) {
            document.getElementById('avatar').src = imgSrc;
        }
    }

    async function checkTokenAndLoadData() {
        const token = localStorage.getItem('token');
        if (!token) {
            alert('未监测到登录状态，请登录');
            window.location.href = 'index.html';
            return;
        }

        try {
            const response = await fetch("/user/checkToken", {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                throw new Error('网络请求失败');
            }

            const res = await response.json();
            if (res.data) {
                localStorage.setItem("token", token); // 重新存储token，如果需要
                const email = getQueryStringValue("email") || '';
                const type = getQueryStringValue("type") || '';
                await fetchShares(email, type);
            } else {
                alert(res.message);
                window.location.href = 'index.html';
            }
        } catch (error) {
            console.error('请求错误:', error);
            alert('请求失败，请检查网络连接');
        }
    }

    function getQueryStringValue(key) {
        const params = new URLSearchParams(window.location.search);
        return params.get(key);
    }

    window.onload = async function () {
        await loadImg();
        await checkTokenAndLoadData();
    }


    function openModal(modalId) {
        document.getElementById(modalId).style.display = 'flex';
    }

    function openEmailModal(id, type) {
        fetchConfigOptions(type); // 获取配置选项
        document.getElementById('distribute_share_id').value = id;
        document.getElementById('configModal').style.display = 'flex';
    }

    function shareEmailQuery() {
        const email = document.getElementById('share-email-query').value
        fetchShares(email,'')
    }


    function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
    }
    document.getElementById('shareNav').addEventListener('click', function () {
        fetchShares('','')
    });

    document.getElementById('accountNav').addEventListener('click',async function (event) {
        event.preventDefault()
        window.location.href = 'account.html';
    });

    document.getElementById('carNav').addEventListener('click',async function (event) {
        event.preventDefault()
        window.location.href = 'car.html';
    });


    function updatePagination() {
        const pageInfo = document.getElementById('sharePageInfo');
        const totalPages = Math.ceil(total / 8);
        pageInfo.textContent = `第 ${curSharePage} 页，共 ${totalPages} 页`;

        document.getElementById('sharePrevBtn').disabled = curSharePage === 1;
        document.getElementById('shareNextBtn').disabled = curSharePage === totalPages;
    }

    document.getElementById('sharePrevBtn').addEventListener('click', () => {
        let email = document.getElementById('share-email-query').value
        if (curSharePage > 1) {
            curSharePage--;
            fetchShares(email === undefined ? '' : email,'');
        }
    });

    document.getElementById('shareNextBtn').addEventListener('click', () => {
        let email = document.getElementById('share-email-query').value
        const totalPages = Math.ceil(total / 8);
        if (curSharePage < totalPages) {
            curSharePage++;
            fetchShares(email === undefined ? '' : email,'');
        }
    });

    function getQueryStringValue(key) {
        return decodeURIComponent(window.location.search.replace(new RegExp("^(?:.*[&\\?]" + encodeURIComponent(key).replace(/[\.\+\*]/g, "\\$&") + "(?:\\=([^&]*))?)?.*$", "i"), "$1"));
    }


    let timeout;
    const userMenu = document.querySelector('.user-menu');
    const dropdown = document.querySelector('.dropdown');

    userMenu.addEventListener('mouseenter', () => {
        clearTimeout(timeout);
        dropdown.style.display = 'block';
    });

    userMenu.addEventListener('mouseleave', () => {
        timeout = setTimeout(() => {
            dropdown.style.display = 'none';
        }, 300); // 300ms 延迟
    });

    dropdown.addEventListener('mouseenter', () => {
        clearTimeout(timeout);
    });

    dropdown.addEventListener('mouseleave', () => {
        timeout = setTimeout(() => {
            dropdown.style.display = 'none';
        }, 300); // 300ms 延迟
    });

    function logout() {
        localStorage.removeItem('token')
        window.location.href = 'index.html'
        localStorage.removeItem('img')
    }

</script>

</html>


